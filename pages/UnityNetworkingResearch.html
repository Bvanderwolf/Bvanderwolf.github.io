<html>

<head>
  <link rel="shortcut icon" href="/img/devicon.png" />
  <link rel="stylesheet" href="/css/bootstrap.css" />
  <link rel="stylesheet" href="/css/custom.css" />
  <link rel="stylesheet" href="/fontawesome/all.css" />
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow sticky-top">
    <div class="container">
      <a class="navbar-brand" href="/index.html">Bvanderwolf</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
        aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/index.html">Home
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Projects <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a class="nav-link" href="/pages/projects.html">Applications</a></li>
              <li><a class="nav-link" href="#">Research</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Code <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a class="nav-link" href="MathRecyclerCode.html">MathRecycler</a></li>
              <li><a class="nav-link" href="HubGamesCode.html">HubGames</a></li>
              <li><a class="nav-link" href="CMSCode.html">CMS</a></li>
              <li><a class="nav-link" href="BoatGameCode.html">BoatGame</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="contact.html">Contact</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Full Page Image Header with Vertically Centered Content -->
  <header class="background-report">
    <div class="container">
      <h1 class="text-center p-5">Creating a 2D Multiplayer Racing Game</h1>
      <h2 class="text-center p-2">Introduction</h2>
      <p class="lead-s text-left pt-2 pb-5">
        How do I create a 2d multiplayer racing game with lag and packet loss compensation and desync-avoidance? To find
        this out I will
        take a look at the Photon Unity3D Networking Framework and create a project using Photon for the Unity Engine,
        to research this
        very topic.
        <br /><br />During this project I will research various industry examples and/or documentation to find my own
        optimal solution to
        the problems I will face making this application. <br /><br />I will try to implement my own synchronization
        code based on the
        research done and document the process and the things I found out. In the last chapter I will explain my own
        solution and try to
        argue why I think it is the optimal solution for my use case.
      </p>
      <h2 class="text-center p-2">Setting up the project</h2>
      <p class="lead-s text-left pt-2 pb-5">
        Before I can start my research I will have to set up my project with the Photon Unity3D Networking Framework.
        Since this is not
        the main focus of my report I will try to spend as little time as possible on this. To actually get to a context
        where players,
        steering their cars, will have to synchronize the cars on their client with the other’s, I will first have to do
        some setting up.
      </p>
      <h3 class="text-center p-2">Connecting to a Photon Server</h3>
      <p class="lead-s text-left pt-2">
        The first step is that you connect with Photon’s servers (Also called the master server). There are 4 ways to
        connect to a Photon
        server. 2 of which are cloud servers. Here are all 4 in code:
      </p>
      <img class="rounded d-block" src="/img/rapports/UnityNetworking/snippit_connectmaster.png" alt="" />
      <p class="lead-s font-italic text-left p-2">Figure 1. Connecting to Master options</p>
      <p class="lead-s text-left">
        The first option (and the one I’m using) uses a scriptable object called PhotonServerSettings to connect to a
        Photon Server based
        on settings configured in that scriptable object. The second option gives you the option to fill in a specific
        master server
        address, a port and your app ID for verification. The app Id is related to the Photon Project from which you are
        making the call.
        The 3th option connects you to the best Photon cloud server based on ping and the fourth gives you an option to
        connect to a
        Photon cloud server in a given region.
        <br />Facilitating connecting to Master in a unity scene, I did with a simple “Connect to Master” Button
      </p>
      <img class="rounded d-block" src="/img/rapports/UnityNetworking/unity_connect_1.png" alt="" />
      <p class="lead-s font-italic text-left p-2">Figure 2. The Connect to master button</p>
      <h3 class="text-center p-2">Connecting to a Room</h3>
      <p class="lead-s text-left pt-2">
        The second step is that you connect to a room. In a room is where you start connecting with players, sending
        data back and forth.
        There are 4 ways to connect to a room. Here are all 4 in code:
      </p>
      <img class="rounded d-block" src="/img/rapports/UnityNetworking/snippit_connectroom.png" alt="" />
      <p class="lead-s font-italic text-left p-2">Figure 3. Connecting to Room options</p>
      <p class="lead-s text-left">
        The first option (and the one I’m using) tries joining a room with a given name, room options and lobby type and
        creates one if
        there isn’t one already. The second option tries joining a random available room. The third option joins a room
        with given name
        and the 4th and last option creates a room with given name and given room options. Joining a room will fail if
        no rooms have been
        made yet. This is why I use the first option so I will always have a guaranteed room even if none has been made
        already.
        <br /><br />Facilitating connecting to a Room, I did by updating the “Connect to Master” button to a “Connect to
        Room” button when
        connecting to master was successful.
      </p>
      <img class="rounded d-block" src="/img/rapports/UnityNetworking/unity_connect_2.png" alt="" />
      <p class="lead-s font-italic text-left p-2">Figure 4. The Connect to room button</p>
      <h3 class="text-center p-2">The Room process</h3>
      <p class="lead-s text-left pt-2">
        When inside the room, there needs to be a way to start the game. There needs to be a definition as to when the
        game can be started
        and there also needs to be some sort of authoritative client to actually make the call to start the game.
        <br /></br />Looking at how a
        lot of games handle this room setup scenario I think I will follow the lead by introducing ready buttons for
        each player to
        communicate their ready status to others. When the last player to ready up has done this, there needs to be the
        authoritative
        client to check if all players have readied up or not. <br /><br />Instead of having a server-client model,
        Photon provides a master client
        option, for developers to give additional rights to or give authoritative power. In this room setup scenario, I
        decided that It
        would be the master client to check on the ready status of all players and to decide on whether to start the
        game or not.
        <br /><br />Facilitating this I added, for each player, a player info item with a ready button. Players can also
        see, in the top left corner,
        information on the room they are in.
      </p>
      <div class="row">
        <div class="col-sm">
          <img class="rounded" src="/img/rapports/UnityNetworking/unity_connect_3.png" alt="" />
          <p class="lead-s font-italic text-left p-2">Figure 5. One player inside the room</p>
        </div>
        <div class="col-sm">
          <img class="rounded" src="/img/rapports/UnityNetworking/unity_connect_4.png" alt="" />
          <p class="lead-s font-italic text-left p-2">Figure 6. Two players inside the room</p>
        </div>
      </div>
      <p class="lead-s text-left">
        Wanting to visualize the process from opening the application to actually starting the game, I created some
        diagrams.
      </p>
      <img class="rounded p-1" src="/img/rapports/UnityNetworking/ApplicationFlow_Connect.png" alt="" />
      <img class="rounded p-1" src="/img/rapports/UnityNetworking/ApplicationFlow_room.png" alt="" />
      <img class="rounded pt-1 pb-5" src="/img/rapports/UnityNetworking/SceneGamePhaseRelation.png" alt="" />
      <h2 class="text-center p-2">Researching Industry Examples</h2>
      <p class="lead-s text-left">
        The first big company that I found had some interesting information on Multiplayer Networking was Valve. They
        had 2 interesting pages which included a lot of documentation on their “Source” engine and its networking, going
        very much in depth about tick rates and lag compensation. I found a GDC talk by Glenn Fiedler, also known as
        Gaffer On Games which included a lot of basic knowledge on the different categories of synchronizing objects and
        optimizing networking especially related to Physics.
      </p>
      <h3 class="text-center p-2">Valve their Source engine</h3>
      <p class="lead-s text-left">
        On their documentation page about their software they give a short definition of what a server is. “Usually a
        server is a dedicated host that runs the game and is authoritative about world simulation, game rules and player
        input processing” (Bernier, 2019). Communication is done by sending small data packets at a high frequency. The
        clients receive the current world state and generate video and audio output based on these updates. The server
        receives sampled inputs from the clients so it can process these for a new world state update.
        <br><br>
        Important to note here is that this description relates to a Client-Server networking architecture. In this
        architecture, clients only communicate with the server and not with each other. A peer-to-peer application would
        facilitate this (Bernier, 2019).
      </p>
      <p class="lead-s text-left">Making this work is hard because of the following reasons:</p>
      <ul>
        <li class="lead-s">
          Network bandwidth is limited, so the server can’t send a new update packet to all clients for every single
          world change.
        </li>
        <li class="lead-s">
          Network packets take a certain amount of time to travel between the client and the server. This means that the
          client is always a little bit behind the server time.
        </li>
        <li class="lead-s">
          Client input packets are, because of reason 2, delayed on their way back. This means the server is always
          processing temporally delayed user commands.
        </li>
        <li class="lead-s">
          Each client has a different network delay which varies over time due to other background traffic and client’s
          framerate.
        </li>
        <li class="lead-s">
          Issues like lag (where packets take longer than normal to travel), packet-loss (where some packets don’t reach
          the destination) and jitter (where time between packets varies a lot) can cause strange effects to normally
          smooth gameplay.
        </li>
      </ul>
      <img class="rounded pt-4" src="/img/rapports/UnityNetworking/serverTicksVisualized.gif" alt="" />
      <p class="lead-s font-italic text-left p-2">Figure 7. Game server ticks visualized</p>
    </div>
  </header>
  <script src="/js/jQuery.min.js"></script>
  <script src="/js/bootstrap.bundle.min.js"></script>
</body>

</html>